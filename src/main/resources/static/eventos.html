<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Artia Pasteler√≠a - Eventos</title>

  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/inicio.css">
  <link rel="stylesheet" href="/css/eventos.css">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;700&family=Dancing+Script:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
  .toast{position:fixed;right:16px;bottom:16px;background:#2e7d32;color:#fff;
    padding:12px 16px;border-radius:8px;display:none;z-index:60}
  .toast.show{display:block}

  .form-card{
    background:#fff;border:1px solid #e2d6c9;border-radius:16px;
    padding:24px 32px;max-width:1000px;margin:24px auto;
    box-sizing:border-box;
  }

  .form-group-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    column-gap:24px;
    row-gap:18px;
  }

  .form-field{
    display:flex;
    flex-direction:column;
    gap:8px;              /* espacio entre label y campo */
    margin-bottom:6px;    /* separa cada campo del siguiente */
  }

  .form-field input,
  .form-field select,
  .form-field textarea{
    padding:10px 12px;
    border:1px solid #d7c6b6;
    border-radius:8px;
    width:100%;
    box-sizing:border-box;
  }

  .full-width{grid-column:1 / -1}

  .btn-submit-form{
    display:inline-block;background:#6b3e1e;color:#fff;border:none;
    border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer;
    margin-top:12px;
  }

  .section-title{text-align:center;margin:18px 0 16px}
  .card{border:1px solid #e2d6c9;border-radius:10px;padding:12px;background:#fff;margin:10px 0}
  .hint{color:#6b6b6b}

  /* üì± Celular */
  @media (max-width:768px){
    .form-card{
      margin:16px 16px 32px;  /* margen con el borde del recuadro */
      padding:20px 16px;
    }
    .form-group-row{
      grid-template-columns:1fr; /* una sola columna */
    }
    .full-width{grid-column:1 / -1}
  }
</style>

</head>
<body>

<!-- HEADER IGUAL A INICIO -->
<header class="top-header">
  <div class="header-top">
    <a href="/inicio.html" class="logo">
      <img src="/img/logo.png" alt="Artia Logo" />
    </a>

    <div class="search-container">
      <span class="material-symbols-outlined" aria-hidden="true">search</span>
      <input type="text" placeholder="¬øQu√© comemos hoy...?" aria-label="Buscar"/>
    </div>

    <div class="header-icons">
      

      <div class="user-wrap">
        <button id="userBtn" class="icon-btn" aria-label="Perfil">
          <span class="material-symbols-outlined">account_circle</span>
        </button>

        <div id="userMenu" class="user-menu" hidden>
          <div class="user-menu-header">
            <span id="userName">Invitado</span>
          </div>
          <a href="/login.html" id="loginLink">Iniciar sesi√≥n</a>
          <a href="/registro.html" id="registerLink">Crear cuenta</a>
          <button id="logoutBtn" class="logout-btn">Cerrar sesi√≥n</button>
        </div>
      </div>

      <a href="/carrito.html"
         class="icon-btn"
         style="display:inline-flex;align-items:center;justify-content:center"
         aria-label="Carrito">
        <span class="material-symbols-outlined">shopping_cart</span>
      </a>
    </div>
  </div>
</header>

<!-- NAV IGUAL A INICIO (EVENTOS ACTIVO) -->
<header class="main-header">
  <nav class="main-nav" id="mainNav">
    <ul>
      <li><a href="/inicio.html">Inicio</a></li>
      <li><a href="/nosotros.html">Nosotros</a></li>
      <li><a href="/catalogo.html">Cat√°logo</a></li>
      <li><a href="/eventos.html" class="active">Eventos</a></li>
      <li><a href="/contacto.html">Contacto</a></li>
      <li><a href="/rese√±as.html">Rese√±as</a></li>
      <li><a href="/foro.html">Foro</a></li>
     
    </ul>
  </nav>
</header>

<main id="eventos">
  <section class="solicita-evento-section" id="solicita-evento">
    <h2 class="section-title">¬°SOLICITA TU EVENTO AQU√ç!</h2>
    <div class="form-card">
      <form id="form-evento" class="solicita-form" novalidate>
        <div class="form-group-row">
          <div class="form-field">
            <label for="tipo_evento">Tipo de Evento</label>
            <select id="tipo_evento">
              <option value="" selected>Selecciona‚Ä¶</option>
              <option value="Boda">Boda</option>
              <option value="Cumplea√±os/Aniversario">Cumplea√±os / Aniversario</option>
              <option value="Corporativo">Corporativo</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div class="form-field">
            <label for="invitados">Invitados (opcional)</label>
            <input type="number" id="invitados" min="10" placeholder="Ej. 50"/>
          </div>
        </div>

        <div class="form-group-row">
          <div class="form-field">
            <label for="fecha">Fecha del Evento</label>
            <input type="date" id="fecha" required/>
          </div>
          <div class="form-field">
            <label for="hora">Hora del Evento</label>
            <input type="time" id="hora"/>
          </div>
        </div>

        <div class="form-group-row">
          <div class="form-field">
            <label for="distrito">Distrito</label>
            <select id="distrito">
              <option value="">Selecciona‚Ä¶</option>
              <option>Ica</option><option>La Tingui√±a</option><option>Los Aquijes</option>
              <option>Ocucaje</option><option>Pachac√∫tec</option><option>Parcona</option>
              <option>Pueblo Nuevo</option><option>Salas</option>
              <option>San Jos√© de los Molinos</option><option>San Juan Bautista</option>
              <option>Santiago</option><option>Subtanjalla</option><option>Tate</option>
              <option>Yauca del Rosario</option>
            </select>
          </div>
          <div class="form-field">
            <label for="direccion">Direcci√≥n</label>
            <input id="direccion" type="text" placeholder="Ej. Av. Lima 123"/>
          </div>
        </div>

        <div class="form-group-row full-width">
          <div class="form-field full-width">
            <label for="referencia">Referencia</label>
            <input id="referencia" type="text" placeholder="Frente al parque‚Ä¶"/>
          </div>
        </div>

        <div class="form-group-row full-width">
          <div class="form-field full-width">
            <label for="detalles">Comentarios / Detalles</label>
            <textarea id="detalles" rows="3" placeholder="Cu√©ntanos m√°s‚Ä¶"></textarea>
          </div>
        </div>

        <button type="submit" class="btn-submit-form">ENVIAR SOLICITUD</button>
        <small class="hint">El estado queda <b>EN_REVISION</b> hasta confirmar.</small>
      </form>
    </div>
  </section>

  <section class="section-card" style="margin-top:18px">
    <h2 class="section-title">Mis eventos</h2>
    <div id="historial-eventos"><small>Cargando‚Ä¶</small></div>
  </section>
</main>

<div id="toast" class="toast"></div>
<footer>
  <div class="footer-container">
    <div class="footer-col">
      <h4>ESCR√çBENOS</h4>
      <p>+51 222 222 222</p>
      <p>artiapasteleria.com</p>
      <div class="social-icons">
        <!-- √çconos gen√©ricos (sin logos de marca) -->
        <a href="#"><span class="material-symbols-outlined">public</span></a>
        <a href="#"><span class="material-symbols-outlined">photo_camera</span></a>
        <a href="#"><span class="material-symbols-outlined">share</span></a>
      </div>
    </div>
    <div class="footer-col">
      <h4>INFORMACI√ìN</h4>
      <a href="#">T√©rminos y condiciones</a>
      <a href="#">Pol√≠ticas de Privacidad</a>
      <a href="#">Libro de Reclamaciones</a>
    </div>
    <div class="footer-col footer-logo">
      <img src="/img/logo2.png" alt="Logo Artia Footer" />
    </div>
  </div>
</footer>

<div class="floating-buttons">
  <a href="#" aria-label="WhatsApp">
    <img src="/img/whatsApp.jpg" alt="WhatsApp" />
  </a>

  <a href="#" aria-label="Chat" id="chatbotToggle">
    <img src="/img/chatbot.png" alt="Chat" />
  </a>
</div>

<!-- üìå Ventana del Chatbot (queda oculta al inicio) -->
<div id="chatbotWidget" class="chatbot-widget hidden">
  <div class="chatbot-header">
    <span>Artia Bot</span>
    <button id="chatbotClose" class="chatbot-close">√ó</button>
  </div>
  <div id="chatbotMessages" class="chatbot-messages"></div>
  <form id="chatbotForm" class="chatbot-input">
    <input id="chatbotText" type="text" placeholder="Escribe tu mensaje..." autocomplete="off"/>
    <button type="submit">Enviar</button>
  </form>
</div>
<script>
if(!localStorage.getItem('token')) location.href='/login.html';

function toast(m,ok=true){const t=document.getElementById('toast');t.textContent=m;t.style.background=ok?'#2e7d32':'#c62828';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}
const authFetch=(url,opt={})=>{const tok=localStorage.getItem('token');const h={...(opt.headers||{})};if(tok)h.Authorization='Bearer '+tok;return fetch(url,{...opt,headers:h});};
function parseJwt(t){try{const b=t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');return JSON.parse(atob(b));}catch{return {};}}
async function ensureClienteId(){const c=+localStorage.getItem('idCliente')||0;if(c)return c;const t=localStorage.getItem('token');if(!t)return 0;const p=parseJwt(t);const id=p.idCliente??p.clienteId??p.id??p.userId??p.sub??0;if(id){localStorage.setItem('idCliente',String(id));return +id;}return 0;}

async function fetchEventos(){
  const cont=document.getElementById('historial-eventos');
  const id=await ensureClienteId();if(!id){cont.innerHTML='<small>Inicia sesi√≥n para ver tus eventos.</small>';return;}
  try{
    const r=await authFetch(`/api/eventos?clienteId=${id}`);if(!r.ok)throw 0;
    const data=await r.json();
    if(!data.length){cont.innerHTML='<small>No tienes eventos a√∫n.</small>';return;}
    cont.innerHTML=data.map(e=>`
      <div class="card">
        <strong>Evento #${e.idEvento}</strong> ‚Äî ${e.tipoEvento||'Sin tipo'}
        <div><b>Fecha:</b> ${e.fechaEvento||'‚Äî'} ${e.horaEvento||''}</div>
        <div><b>Invitados:</b> ${e.invitados??'‚Äî'}</div>
        <div><b>Detalles:</b> ${e.detalles||'‚Äî'}</div>
        <div><b>Direcci√≥n:</b> ${e.distrito||''} ${e.direccion||''}</div>
        <div><b>Estado:</b> ${e.estado||'EN_REVISION'}</div>
      </div>
    `).join('');
  }catch{cont.innerHTML='<small>Error cargando eventos.</small>';}
}

document.getElementById('form-evento').addEventListener('submit',async e=>{
  e.preventDefault();
  const idCliente=await ensureClienteId();if(!idCliente){toast('Inicia sesi√≥n',false);return;}
  const body={
    idCliente,
    tipo_evento:document.getElementById('tipo_evento').value||null,
    invitados:Number(document.getElementById('invitados').value||0)||null,
    fechaEvento:document.getElementById('fecha').value||null,
    horaEvento:document.getElementById('hora').value||null,
    estado:'EN_REVISION',
    distrito:document.getElementById('distrito').value||null,
    direccion:document.getElementById('direccion').value?.trim()||null,
    referencia:document.getElementById('referencia').value?.trim()||null,
    detalles:document.getElementById('detalles').value?.trim()||null,
    comentarios:document.getElementById('detalles').value?.trim()||null
  };
  if(!body.fechaEvento){toast('Elige una fecha',false);return;}
  if(!body.distrito||!body.direccion){toast('Completa distrito y direcci√≥n',false);return;}
  try{
    const r=await authFetch('/api/eventos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json().catch(()=>({}))).error||'Error');
    const {idEvento}=await r.json();
    toast(`Evento #${idEvento} registrado (EN_REVISION)`);e.target.reset();fetchEventos();
  }catch(err){toast(err.message||'Error',false);}
});
fetchEventos();
</script>

<script>
// ==== BUSCADOR GLOBAL CON SUGERENCIAS ====
(function(){
  const searchContainer = document.querySelector('.search-container');
  if (!searchContainer) return;

  const input = searchContainer.querySelector('input');
  if (!input) return;

  // Caja de sugerencias
  const box = document.createElement('div');
  box.className = 'search-suggestions';
  searchContainer.appendChild(box);

  let allProducts = null;   // cach√© en memoria
  let loading = false;

  async function loadProducts() {
    if (allProducts || loading) return;
    loading = true;
    try {
      const r = await fetch('/api/productos');
      if (!r.ok) throw 0;
      allProducts = await r.json();
    } catch {
      allProducts = [];
    } finally {
      loading = false;
    }
  }

  function filtrarProductos(q) {
    if (!allProducts) return [];
    const term = q.toLowerCase();
    if (!term) return [];
    return allProducts
      .filter(p => {
        const nombre = (p.nombre || '').toLowerCase();
        const desc   = (p.descripcion || '').toLowerCase();
        return nombre.includes(term) || desc.includes(term);
      })
      .slice(0, 5); // m√°ximo 5 sugerencias
  }

  function mostrarSugerencias(lista, q) {
    if (!lista.length) {
      box.style.display = 'none';
      return;
    }
    box.innerHTML = lista.map(p => `
      <div class="search-suggestion-item" data-nombre="${p.nombre}">
        <strong>${p.nombre}</strong>
        <small>S/ ${Number(p.precio).toFixed(2)}</small>
      </div>
    `).join('');
    box.style.display = 'block';

    box.querySelectorAll('.search-suggestion-item').forEach(item => {
      item.addEventListener('click', () => {
        const nombre = item.dataset.nombre;
        input.value = nombre;
        irACatalogo(nombre);
      });
    });
  }

  function irACatalogo(termino) {
    const url = '/catalogo.html?q=' + encodeURIComponent(termino);

    // Si ya estamos en cat√°logo, intentar filtrar sin recargar
    if (location.pathname.endsWith('/catalogo.html') &&
        typeof window.aplicarBusquedaCatalogo === 'function') {
      history.replaceState(null, '', url);
      window.aplicarBusquedaCatalogo(termino);
    } else {
      location.href = url;
    }
  }

  // Eventos
  input.addEventListener('input', async () => {
    const value = input.value.trim();
    if (!value) {
      box.style.display = 'none';
      return;
    }
    await loadProducts();
    const lista = filtrarProductos(value);
    mostrarSugerencias(lista, value);
  });

  input.addEventListener('focus', async () => {
    const value = input.value.trim();
    if (!value) return;
    await loadProducts();
    const lista = filtrarProductos(value);
    mostrarSugerencias(lista, value);
  });

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const term = input.value.trim();
      if (!term) return;
      box.style.display = 'none';
      irACatalogo(term);
    }
  });

  // Cerrar sugerencias al hacer clic fuera
  document.addEventListener('click', (e) => {
    if (!searchContainer.contains(e.target)) {
      box.style.display = 'none';
    }
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const toggleBtn = document.getElementById('chatbotToggle');
  const closeBtn  = document.getElementById('chatbotClose');
  const widget    = document.getElementById('chatbotWidget');
  const form      = document.getElementById('chatbotForm');
  const input     = document.getElementById('chatbotText');
  const messages  = document.getElementById('chatbotMessages');

  // ====== 1) Abrir / cerrar ======
  function openChat() {
    widget.classList.remove('hidden');
    input.focus();
  }
  function closeChat() {
    widget.classList.add('hidden');
  }

  toggleBtn.addEventListener('click', e => {
    e.preventDefault();
    widget.classList.contains('hidden') ? openChat() : closeChat();
  });
  closeBtn.addEventListener('click', closeChat);

  // ====== 2) Utilidades de mensajes ======
  function addMessage(text, from = 'bot') {
    const div = document.createElement('div');
    div.className = `chatbot-msg ${from}`;
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  // ====== 3) Cargar productos desde tu backend ======
  let productosCache = [];
  let ultimasSugerencias = []; // para luego poder "agrega el 1"

  async function cargarProductos() {
    try {
      const r = await fetch('/api/productos');
      if (!r.ok) throw new Error('Error al cargar productos');
      productosCache = await r.json(); // se espera algo tipo [{idProducto,nombre,precio,imagenUrl,stock},...]
    } catch (err) {
      console.error(err);
      productosCache = [];
    }
  }

  // normalizar texto (min√∫sculas, sin tildes)
  function normalizar(str) {
    return (str || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '');
  }

  // buscar productos por texto usando coincidencias simples (pseudo-IA)
  function buscarProductosPorTexto(texto) {
    if (!productosCache.length) return [];
    const q = normalizar(texto);
    const tokens = q.split(/\s+/).filter(t => t.length > 2);

    const resultados = productosCache.map(p => {
      const base = normalizar(p.nombre + ' ' + (p.descripcion || '') + ' ' + (p.categoria || ''));
      let score = 0;

      tokens.forEach(t => {
        if (base.includes(t)) score += 2;          // coincidencia normal
        if (base.startsWith(t)) score += 1;        // parecido al comienzo
      });

      if (q.includes('torta') || q.includes('pastel')) {
        if (base.includes('torta') || base.includes('pastel')) score += 1;
      }
      if (q.includes('chocolate') && base.includes('chocolate')) score += 1;
      if (q.includes('fresa') && base.includes('fresa')) score += 1;

      return { prod: p, score };
    });

    return resultados
      .filter(r => r.score > 0)
      .sort((a,b) => b.score - a.score)
      .slice(0, 3)              // top 3 sugerencias
      .map(r => r.prod);
  }

  // ====== 4) Intentar agregar producto por √≠ndice (1,2,3) ======
  function intentarAgregarPorIndice(texto) {
    if (!ultimasSugerencias.length) return false;
    const t = normalizar(texto);
    let idx = null;

    if (/primer|primero|1\b/.test(t)) idx = 0;
    else if (/segundo|2\b/.test(t))   idx = 1;
    else if (/tercer|tercero|3\b/.test(t)) idx = 2;

    if (idx === null || !ultimasSugerencias[idx]) return false;

    const p = ultimasSugerencias[idx];
    if (typeof window.addToCart === 'function') {
      window.addToCart(p.nombre, Number(p.precio), p.imagenUrl || '/img/placeholder.png', p.idProducto);
      addMessage(`Listo, agregu√© ‚Äú${p.nombre}‚Äù al carrito üõí`, 'bot');
    } else {
      addMessage(`No encontr√© la funci√≥n de carrito, pero te recomiendo ‚Äú${p.nombre}‚Äù.`, 'bot');
    }
    return true;
  }

  // ====== 5) L√≥gica principal de respuesta "inteligente" ======
  function generarRespuesta(textoOriginal) {
    const t = normalizar(textoOriginal);

    // saludos
    if (/hola|buenas|hey|holaa/.test(t)) {
      return '¬°Hola! Soy Artia Bot ü§ñüç∞. Puedo ayudarte con productos, recomendaciones y delivery.';
    }

    // horario
    if (t.includes('horario') || t.includes('hora') || t.includes('abren') || t.includes('cierran')) {
      return 'üïê Atendemos de lunes a s√°bado de 9:00 am a 9:00 pm y domingos de 10:00 am a 7:00 pm.';
    }

    // delivery
    if (t.includes('delivery') || t.includes('envio') || t.includes('enviar')) {
      return 'üöö Hacemos delivery en Ica. El tiempo aproximado es de 40 a 60 minutos seg√∫n la zona.';
    }

    // ubicaci√≥n
    if (t.includes('donde estan') || t.includes('direccion') || t.includes('ubicacion') || t.includes('ubicaci√≥n')) {
      return 'üìç Estamos en Av. Lima 123 ‚Äì Ica (referencia: a media cuadra del parque principal).';
    }

    // intento de "agrega el 1 / el segundo / el tercero" al carrito
    if (/agrega|a√±ade|pon en el carrito|agregalo|agr√©galo|lo quiero|lo compro/.test(t)) {
      const ok = intentarAgregarPorIndice(t);
      if (ok) return null; // ya respondimos dentro de la funci√≥n
      // si no se pudo por √≠ndice, sigue con recomendaci√≥n normal
    }

    // b√∫squeda de productos seg√∫n lo que escribe
    const sugerencias = buscarProductosPorTexto(textoOriginal);
    if (sugerencias.length) {
      ultimasSugerencias = sugerencias;

      let msg = 'Seg√∫n lo que me dices, te podr√≠an gustar:\n';
      sugerencias.forEach((p, i) => {
        msg += `\n${i+1}) ${p.nombre} ‚Äì S/ ${Number(p.precio).toFixed(2)}`;
        if (p.descripcion) msg += `\n   ${p.descripcion}`;
      });
      msg += '\n\nPuedes decirme: "agrega el 1", "agrega el segundo", etc. para ponerlo en el carrito. üõí';
      return msg;
    }

    // preguntas de precios generales
    if (t.includes('precio') || t.includes('cuanto cuesta') || t.includes('cu√°nto cuesta')) {
      return 'Dime qu√© producto te interesa (por ejemplo: "precio de la torta de chocolate") y te muestro opciones con sus precios.';
    }

    // fallback
    return 'üòä Soy Artia Bot. Puedo recomendarte tortas, postres, caf√©s, explicarte nuestro delivery u horario. Preg√∫ntame algo como "recomi√©ndame una torta de chocolate para 10 personas".';
  }

  // ====== 6) Carga inicial ======
  await cargarProductos();
  addMessage('¬°Hola! Soy Artia Bot ü§ñüç∞ ¬øEn qu√© te ayudo hoy?');

  // ====== 7) Enviar mensaje ======
  form.addEventListener('submit', e => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, 'user');
    input.value = '';

    setTimeout(() => {
      const resp = generarRespuesta(text);
      if (resp) addMessage(resp, 'bot');
      // si resp es null, fue porque ya se mand√≥ mensaje dentro de intentarAgregarPorIndice
    }, 350);
  });

});
</script>

</body>
</html>
