<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Artia Pasteler√≠a - Cat√°logo</title>

  <!-- Estilos base -->
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/inicio.css"/>
  <link rel="stylesheet" href="/css/catalogo.css"/>

  <!-- Material Symbols (Google) -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;700&family=Dancing+Script:wght@700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

  <style>
    .material-symbols-outlined{
      font-family:"Material Symbols Outlined";
      font-weight:normal;font-style:normal;font-size:24px;line-height:1;
      display:inline-block;vertical-align:middle;letter-spacing:normal;
      text-transform:none;white-space:nowrap;word-wrap:normal;direction:ltr;
      font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24;
    }
    .user-wrap{position:relative;display:inline-block}
    .icon-btn{border:0;background:#f9e9d6;width:48px;height:48px;border-radius:50%;cursor:pointer}
    .user-menu{
      position:absolute;right:0;top:56px;background:#fff;border:1px solid #ddd;
      border-radius:12px;min-width:180px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:1000;
    }
    .user-menu a,.user-menu button{
      display:block;width:100%;text-align:left;padding:8px 10px;background:none;border:0;cursor:pointer;
    }
  </style>
</head>

<body class="page-catalogo">

<!-- HEADER IGUAL A INICIO -->
<header class="top-header">
  <div class="header-top">
    <a href="/inicio.html" class="logo">
      <img src="/img/logo.png" alt="Artia Logo"/>
    </a>

    <div class="search-container">
      <span class="material-symbols-outlined" aria-hidden="true">search</span>
      <input type="text" placeholder="¬øQu√© comemos hoy...?" id="busqueda" aria-label="Buscar"/>
    </div>

    <div class="header-icons">
      <button class="icon-btn" aria-label="Notificaciones">
        <span class="material-symbols-outlined">notifications</span>
      </button>

      <div class="user-wrap">
        <button id="userBtn" class="icon-btn" aria-label="Perfil">
          <span class="material-symbols-outlined">account_circle</span>
        </button>
        <div id="userMenu" class="user-menu" hidden>
          <div class="user-menu-header"><span id="userName">Invitado</span></div>
          <a href="/login.html" id="loginLink">Iniciar sesi√≥n</a>
          <a href="/registro.html" id="registerLink">Crear cuenta</a>
          <button id="logoutBtn" class="logout-btn">Cerrar sesi√≥n</button>
        </div>
      </div>

      <a href="/carrito.html" aria-label="Carrito" class="icon-btn" style="display:inline-flex;align-items:center;justify-content:center;">
        <span class="material-symbols-outlined">shopping_cart</span>
      </a>
    </div>
  </div>
</header>

<!-- NAV IGUAL A INICIO (CAT√ÅLOGO ACTIVO) -->
<header class="main-header">
  <nav class="main-nav" id="mainNav">
    <ul>
      <li><a href="/inicio.html">Inicio</a></li>
      <li><a href="/nosotros.html">Nosotros</a></li>
      <li><a href="/catalogo.html" class="active">Cat√°logo</a></li>
      <li><a href="/eventos.html">Eventos</a></li>
      <li><a href="/contacto.html">Contacto</a></li>
      <li><a href="/rese√±as.html">Rese√±as</a></li>
      <li><a href="/foro.html">Foro</a></li>
      <li><a href="/puntos.html">Puntos</a></li>
    </ul>
  </nav>
</header>

<main id="catalogo">
  <section class="seccion-catalogo">
    <h1 class="section-title">CAT√ÅLOGO DE PRODUCTOS</h1>
    <div class="separator-line"></div>
    <div id="grid-productos" class="productos-grid"></div>
  </section>
</main>

<footer>
  <div class="footer-container">
    <div class="footer-col">
      <h4>ESCR√çBENOS</h4>
      <p>+51 222 222 222</p>
      <p>artiapasteleria.com</p>
      <div class="social-icons">
        <!-- √çconos gen√©ricos (sin logos de marca) -->
        <a href="#"><span class="material-symbols-outlined">public</span></a>
        <a href="#"><span class="material-symbols-outlined">photo_camera</span></a>
        <a href="#"><span class="material-symbols-outlined">share</span></a>
      </div>
    </div>
    <div class="footer-col">
      <h4>INFORMACI√ìN</h4>
      <a href="#">T√©rminos y condiciones</a>
      <a href="#">Pol√≠ticas de Privacidad</a>
      <a href="#">Libro de Reclamaciones</a>
    </div>
    <div class="footer-col footer-logo">
      <img src="/img/logo2.png" alt="Logo Artia Footer" />
    </div>
  </div>
</footer>

<div class="floating-buttons">
  <a href="#" aria-label="WhatsApp">
    <img src="/img/whatsApp.jpg" alt="WhatsApp" />
  </a>

  <a href="#" aria-label="Chat" id="chatbotToggle">
    <img src="/img/chatbot.png" alt="Chat" />
  </a>
</div>

<!-- üìå Ventana del Chatbot (queda oculta al inicio) -->
<div id="chatbotWidget" class="chatbot-widget hidden">
  <div class="chatbot-header">
    <span>Artia Bot</span>
    <button id="chatbotClose" class="chatbot-close">√ó</button>
  </div>
  <div id="chatbotMessages" class="chatbot-messages"></div>
  <form id="chatbotForm" class="chatbot-input">
    <input id="chatbotText" type="text" placeholder="Escribe tu mensaje..." autocomplete="off"/>
    <button type="submit">Enviar</button>
  </form>
</div>

<script>
/* ==== Sesi√≥n b√°sica (igual a inicio) ==== */
document.addEventListener('DOMContentLoaded', () => {
  const t = localStorage.getItem('token');
  const u = localStorage.getItem('user');

  const userBtn      = document.getElementById('userBtn');
  const userMenu     = document.getElementById('userMenu');
  const userName     = document.getElementById('userName');
  const loginLink    = document.getElementById('loginLink');
  const registerLink = document.getElementById('registerLink');
  const logoutBtn    = document.getElementById('logoutBtn');

  if (t && u) {
    if (userName)     userName.textContent = u;
    if (loginLink)    loginLink.hidden = true;
    if (registerLink) registerLink.hidden = true;
    if (logoutBtn)    logoutBtn.hidden = false;
  } else {
    if (logoutBtn) logoutBtn.hidden = true;
  }

  if (userBtn && userMenu) {
    userBtn.addEventListener('click', e => {
      e.stopPropagation();
      userMenu.toggleAttribute('hidden');
    });
    document.addEventListener('click', () => userMenu.setAttribute('hidden',''));
  }
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      localStorage.clear();
      location.href = '/login.html';
    });
  }
});

/* ==== Toast reutilizable ==== */
window.showToast = function(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style, {
    position:'fixed',right:'20px',bottom:'20px',background:'#6b3e1e',
    color:'#fff',padding:'12px 18px',borderRadius:'10px',
    boxShadow:'0 4px 10px rgba(0,0,0,.25)',opacity:'0',
    transition:'opacity .3s, transform .3s',transform:'translateY(20px)',zIndex:'9999'
  });
  document.body.appendChild(t);
  requestAnimationFrame(()=>{
    t.style.opacity='1';
    t.style.transform='translateY(0)';
  });
  setTimeout(()=>{
    t.style.opacity='0';
    t.style.transform='translateY(20px)';
    setTimeout(()=>t.remove(),400);
  },2500);
};

/* ==== Carrito (incluye idProducto) ==== */
window.addToCart = function(nombre, precio, imagen, idProducto = null){
  const prod = {
    idProducto: idProducto ? Number(idProducto) : null,
    nombre,
    precio,
    imagen,
    cantidad: 1
  };

  let c = JSON.parse(localStorage.getItem('carritoArtia')) || [];
  const i = c.findIndex(p =>
    (p.idProducto && prod.idProducto)
      ? p.idProducto === prod.idProducto
      : p.nombre === prod.nombre
  );
  if (i > -1) {
    c[i].cantidad = Math.min(99, (c[i].cantidad || 1) + 1);
  } else {
    c.push(prod);
  }
  localStorage.setItem('carritoArtia', JSON.stringify(c));
  showToast(`üõí ${nombre} agregado`);
};

/* ==== Cat√°logo: carga desde /api/productos y permite buscar ==== */
(function(){
  const grid       = document.getElementById('grid-productos');
  const searchInput = document.querySelector('.search-container input');

  let productosOriginales = [];

  const cardHtml = (p) => `
    <div class="producto-card"
         data-id="${p.idProducto}"
         data-nombre="${p.nombre}"
         data-precio="${p.precio}"
         data-img="${p.imagenUrl}"
         data-stock="${p.stock}">
      <img src="${p.imagenUrl || '/img/placeholder.png'}"
           alt="${p.nombre}"
           onerror="this.src='/img/placeholder.png'">
      <div class="producto-info">
        <h2>${p.nombre}</h2>
        <p>S/ ${Number(p.precio).toFixed(2)}</p>
        <button class="add-to-cart-btn">Seleccionar</button>
      </div>
    </div>`;

  function renderCatalogo(lista){
    if (!lista || !lista.length) {
      grid.innerHTML = '<p style="grid-column:1/-1">No se encontraron productos.</p>';
      return;
    }
    grid.innerHTML = lista.map(cardHtml).join('');
    grid.querySelectorAll('.add-to-cart-btn').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const card = e.currentTarget.closest('.producto-card');
        const { id, nombre, precio, img } = card.dataset;
        addToCart(nombre, parseFloat(precio), img, id);
      });
    });
  }

  // Funci√≥n global que usar√° el buscador (desde cualquier p√°gina)
  window.aplicarBusquedaCatalogo = function(termino){
    const q = (termino || '').toLowerCase().trim();
    if (!q) {
      renderCatalogo(productosOriginales);
      return;
    }
    const filtrados = productosOriginales.filter(p => {
      const nombre = (p.nombre || '').toLowerCase();
      const desc   = (p.descripcion || '').toLowerCase();
      return nombre.includes(q) || desc.includes(q);
    });
    renderCatalogo(filtrados);
  };

  async function cargarProductos(){
    grid.innerHTML = '<p style="grid-column:1/-1">Cargando productos‚Ä¶</p>';
    try{
      const r = await fetch('/api/productos');
      if (!r.ok) throw new Error();
      productosOriginales = await r.json();

      // Leer ?q= de la URL (cuando vienes desde otra p√°gina)
      const params = new URLSearchParams(location.search);
      const q = params.get('q') || '';

      if (q && searchInput) {
        searchInput.value = q;
        aplicarBusquedaCatalogo(q);
      } else {
        renderCatalogo(productosOriginales);
      }
    }catch{
      grid.innerHTML = '<p style="grid-column:1/-1;color:#b00">Error cargando cat√°logo.</p>';
    }
  }

  // Tambi√©n permitir buscar dentro de cat√°logo sin cambiar de p√°gina
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const term = searchInput.value.trim();
      aplicarBusquedaCatalogo(term);
    });
  }

  cargarProductos();
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const toggleBtn = document.getElementById('chatbotToggle');
  const closeBtn  = document.getElementById('chatbotClose');
  const widget    = document.getElementById('chatbotWidget');
  const form      = document.getElementById('chatbotForm');
  const input     = document.getElementById('chatbotText');
  const messages  = document.getElementById('chatbotMessages');

  // ====== 1) Abrir / cerrar ======
  function openChat() {
    widget.classList.remove('hidden');
    input.focus();
  }
  function closeChat() {
    widget.classList.add('hidden');
  }

  toggleBtn.addEventListener('click', e => {
    e.preventDefault();
    widget.classList.contains('hidden') ? openChat() : closeChat();
  });
  closeBtn.addEventListener('click', closeChat);

  // ====== 2) Utilidades de mensajes ======
  function addMessage(text, from = 'bot') {
    const div = document.createElement('div');
    div.className = `chatbot-msg ${from}`;
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  // ====== 3) Cargar productos desde tu backend ======
  let productosCache = [];
  let ultimasSugerencias = []; // para luego poder "agrega el 1"

  async function cargarProductos() {
    try {
      const r = await fetch('/api/productos');
      if (!r.ok) throw new Error('Error al cargar productos');
      productosCache = await r.json(); // se espera algo tipo [{idProducto,nombre,precio,imagenUrl,stock},...]
    } catch (err) {
      console.error(err);
      productosCache = [];
    }
  }

  // normalizar texto (min√∫sculas, sin tildes)
  function normalizar(str) {
    return (str || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '');
  }

  // buscar productos por texto usando coincidencias simples (pseudo-IA)
  function buscarProductosPorTexto(texto) {
    if (!productosCache.length) return [];
    const q = normalizar(texto);
    const tokens = q.split(/\s+/).filter(t => t.length > 2);

    const resultados = productosCache.map(p => {
      const base = normalizar(p.nombre + ' ' + (p.descripcion || '') + ' ' + (p.categoria || ''));
      let score = 0;

      tokens.forEach(t => {
        if (base.includes(t)) score += 2;          // coincidencia normal
        if (base.startsWith(t)) score += 1;        // parecido al comienzo
      });

      if (q.includes('torta') || q.includes('pastel')) {
        if (base.includes('torta') || base.includes('pastel')) score += 1;
      }
      if (q.includes('chocolate') && base.includes('chocolate')) score += 1;
      if (q.includes('fresa') && base.includes('fresa')) score += 1;

      return { prod: p, score };
    });

    return resultados
      .filter(r => r.score > 0)
      .sort((a,b) => b.score - a.score)
      .slice(0, 3)              // top 3 sugerencias
      .map(r => r.prod);
  }

  // ====== 4) Intentar agregar producto por √≠ndice (1,2,3) ======
  function intentarAgregarPorIndice(texto) {
    if (!ultimasSugerencias.length) return false;
    const t = normalizar(texto);
    let idx = null;

    if (/primer|primero|1\b/.test(t)) idx = 0;
    else if (/segundo|2\b/.test(t))   idx = 1;
    else if (/tercer|tercero|3\b/.test(t)) idx = 2;

    if (idx === null || !ultimasSugerencias[idx]) return false;

    const p = ultimasSugerencias[idx];
    if (typeof window.addToCart === 'function') {
      window.addToCart(p.nombre, Number(p.precio), p.imagenUrl || '/img/placeholder.png', p.idProducto);
      addMessage(`Listo, agregu√© ‚Äú${p.nombre}‚Äù al carrito üõí`, 'bot');
    } else {
      addMessage(`No encontr√© la funci√≥n de carrito, pero te recomiendo ‚Äú${p.nombre}‚Äù.`, 'bot');
    }
    return true;
  }

  // ====== 5) L√≥gica principal de respuesta "inteligente" ======
  function generarRespuesta(textoOriginal) {
    const t = normalizar(textoOriginal);

    // saludos
    if (/hola|buenas|hey|holaa/.test(t)) {
      return '¬°Hola! Soy Artia Bot ü§ñüç∞. Puedo ayudarte con productos, recomendaciones y delivery.';
    }

    // horario
    if (t.includes('horario') || t.includes('hora') || t.includes('abren') || t.includes('cierran')) {
      return 'üïê Atendemos de lunes a s√°bado de 9:00 am a 9:00 pm y domingos de 10:00 am a 7:00 pm.';
    }

    // delivery
    if (t.includes('delivery') || t.includes('envio') || t.includes('enviar')) {
      return 'üöö Hacemos delivery en Ica. El tiempo aproximado es de 40 a 60 minutos seg√∫n la zona.';
    }

    // ubicaci√≥n
    if (t.includes('donde estan') || t.includes('direccion') || t.includes('ubicacion') || t.includes('ubicaci√≥n')) {
      return 'üìç Estamos en Av. Lima 123 ‚Äì Ica (referencia: a media cuadra del parque principal).';
    }

    // intento de "agrega el 1 / el segundo / el tercero" al carrito
    if (/agrega|a√±ade|pon en el carrito|agregalo|agr√©galo|lo quiero|lo compro/.test(t)) {
      const ok = intentarAgregarPorIndice(t);
      if (ok) return null; // ya respondimos dentro de la funci√≥n
      // si no se pudo por √≠ndice, sigue con recomendaci√≥n normal
    }

    // b√∫squeda de productos seg√∫n lo que escribe
    const sugerencias = buscarProductosPorTexto(textoOriginal);
    if (sugerencias.length) {
      ultimasSugerencias = sugerencias;

      let msg = 'Seg√∫n lo que me dices, te podr√≠an gustar:\n';
      sugerencias.forEach((p, i) => {
        msg += `\n${i+1}) ${p.nombre} ‚Äì S/ ${Number(p.precio).toFixed(2)}`;
        if (p.descripcion) msg += `\n   ${p.descripcion}`;
      });
      msg += '\n\nPuedes decirme: "agrega el 1", "agrega el segundo", etc. para ponerlo en el carrito. üõí';
      return msg;
    }

    // preguntas de precios generales
    if (t.includes('precio') || t.includes('cuanto cuesta') || t.includes('cu√°nto cuesta')) {
      return 'Dime qu√© producto te interesa (por ejemplo: "precio de la torta de chocolate") y te muestro opciones con sus precios.';
    }

    // fallback
    return 'üòä Soy Artia Bot. Puedo recomendarte tortas, postres, caf√©s, explicarte nuestro delivery u horario. Preg√∫ntame algo como "recomi√©ndame una torta de chocolate para 10 personas".';
  }

  // ====== 6) Carga inicial ======
  await cargarProductos();
  addMessage('¬°Hola! Soy Artia Bot ü§ñüç∞ ¬øEn qu√© te ayudo hoy?');

  // ====== 7) Enviar mensaje ======
  form.addEventListener('submit', e => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, 'user');
    input.value = '';

    setTimeout(() => {
      const resp = generarRespuesta(text);
      if (resp) addMessage(resp, 'bot');
      // si resp es null, fue porque ya se mand√≥ mensaje dentro de intentarAgregarPorIndice
    }, 350);
  });

});
</script>


</body>
</html>
